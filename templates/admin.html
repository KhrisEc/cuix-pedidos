<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Cuix Studio</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --primary: #FF6B6B; --secondary: #4ECDC4; --dark: #2C3E50; --light: #ECF0F1; --success: #2ECC71; --warning: #F39C12; --sidebar-width: 250px; }
        body { font-family: "Poppins", sans-serif; background: #f5f6fa; min-height: 100vh; display: flex; }
        .sidebar { width: var(--sidebar-width); background: var(--dark); color: white; min-height: 100vh; position: fixed; left: 0; top: 0; padding: 20px 0; }
        .sidebar-logo { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
        .sidebar-logo h1 { font-family: cursive; font-size: 32px; color: var(--primary); }
        .sidebar-menu { list-style: none; }
        .sidebar-menu li { margin: 5px 10px; }
        .sidebar-menu a { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: rgba(255,255,255,0.7); text-decoration: none; border-radius: 8px; transition: all 0.3s; }
        .sidebar-menu a:hover, .sidebar-menu a.active { background: var(--primary); color: white; }
        .sidebar-footer { position: absolute; bottom: 20px; left: 0; right: 0; padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 20px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-header h2 { color: var(--dark); font-size: 24px; }
        .status-tabs { display: flex; gap: 15px; margin-bottom: 25px; }
        .status-tab { flex: 1; background: white; padding: 20px; border-radius: 12px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .status-tab:hover { transform: translateY(-3px); }
        .status-tab.active { border-color: var(--primary); box-shadow: 0 5px 20px rgba(255,107,107,0.2); }
        .status-tab .icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-bottom: 10px; }
        .status-tab.pending .icon { background: #FFF3CD; color: var(--warning); }
        .status-tab.sent .icon { background: #E8F4FD; color: #3498DB; }
        .status-tab.scheduled .icon { background: #E8F8F5; color: var(--secondary); }
        .status-tab.delivered .icon { background: #D4EDDA; color: var(--success); }
        .status-tab .count { font-size: 28px; font-weight: bold; color: var(--dark); }
        .status-tab .label { color: #666; font-size: 13px; }
        .orders-list { background: white; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); overflow: hidden; }
        .orders-list table { width: 100%; border-collapse: collapse; }
        .orders-list th { background: var(--dark); color: white; padding: 15px; text-align: left; font-weight: 500; }
        .orders-list td { padding: 15px; border-bottom: 1px solid #eee; }
        .orders-list tr:hover { background: #fafafa; }
        .orders-list tr { cursor: pointer; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { color: var(--dark); }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
        .modal-body { padding: 25px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--dark); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; font-size: 14px; }
        .form-group input:focus { outline: none; border-color: var(--primary); }
        .form-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: #95A5A6; color: white; }
        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .detail-item { background: #f9f9f9; padding: 12px; border-radius: 8px; }
        .detail-item .label { font-size: 12px; color: #666; margin-bottom: 4px; }
        .detail-item .value { font-weight: 500; color: var(--dark); }
        .whatsapp-btn { background: #25D366; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; margin-top: 15px; }
        .empty-state { text-align: center; padding: 60px; color: #999; }
        .photo-thumbnails { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .photo-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 2px solid #eee; cursor: pointer; transition: transform 0.2s; }
        .photo-thumb:hover { transform: scale(1.1); }
        #photoModal { justify-content: center; align-items: center; }
        #photoModal > div { background: white; padding: 10px; border-radius: 8px; }
        
        /* Estilos para modal de pedido agrupado */
        .detail-section { margin-bottom: 20px; }
        .detail-section-title { font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid var(--primary); }
        .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { color: #666; font-size: 13px; }
        .detail-value { font-weight: 500; color: var(--dark); text-align: right; }
        .detail-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        
        
        .phone-wrap{display:flex;gap:8px;align-items:center}.phone-wrap img{width:24px;height:16px;border-radius:2px}.phone-wrap select{width:70px!important;padding:8px!important}#usersSection { display: none; }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-logo"><h1>CUIX</h1><p>Admin</p></div>
        <ul class="sidebar-menu">
            <li><a href="#" class="active" onclick="showSection('orders')"><i class="fas fa-shopping-cart"></i> Pedidos</a></li>
            <li><a href="#" onclick="showSection('users')"><i class="fas fa-users"></i> Usuarios</a></li>
            <li><a href="#" onclick="showSection('settings')"><i class="fas fa-cog"></i> Configuraci√≥n</a></li>
        </ul>
        <div class="sidebar-footer">
            <div style="display:flex;align-items:center;gap:10px;">
                <div style="width:40px;height:40px;background:var(--primary);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;" id="userInitial">A</div>
                <div><div id="userNameDisplay">Admin</div><small style="color:#999;cursor:pointer;" onclick="logout()">Salir</small></div>
            </div>
        </div>
    </nav>
    <main class="main-content">
        <div id="ordersSection">
            <div class="page-header"><h2>Pedidos</h2></div>
            <div class="status-tabs">
                <div class="status-tab pending active" onclick="filterStatus('pending')"><div class="icon">üìù</div><div class="count" id="countPending">0</div><div class="label">Pendiente</div></div>
                <div class="status-tab sent" onclick="filterStatus('sent')"><div class="icon">üì§</div><div class="count" id="countSent">0</div><div class="label">Enviada</div></div>
                <div class="status-tab scheduled" onclick="filterStatus('scheduled')"><div class="icon">üìÖ</div><div class="count" id="countScheduled">0</div><div class="label">Agendado</div></div>
                <div class="status-tab delivered" onclick="filterStatus('delivered')"><div class="icon">‚úÖ</div><div class="count" id="countDelivered">0</div><div class="label">Entregado</div></div>
            </div>
            <div class="orders-list">
                <table><thead><tr><th>ID</th><th>Cliente</th><th>Tipo</th><th>Fecha</th><th>Precio</th><th>Acci√≥n</th></tr></thead>
                <tbody id="ordersTableBody"><tr><td colspan="6" class="empty-state">Cargando...</td></tr></tbody></table>
            </div>
        </div>
        <div id="usersSection" style="display:none;">
            <div class="page-header"><h2>Usuarios</h2><button class="btn btn-primary" onclick="showCreateUserModal()" style="padding:8px 16px;margin-left:auto;"><i class="fas fa-plus"></i> Nuevo Usuario</button></div>
            <div class="orders-list">
                <table><thead><tr><th>ID</th><th>Usuario</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Acci√≥n</th></tr></thead>
                <tbody id="usersTableBody"><tr><td colspan="6" class="empty-state">Cargando...</td></tr></tbody></table>
            </div>
        </div>
        <div id="settingsSection" style="display:none;">
            <div class="page-header"><h2>Configuraci√≥n</h2></div>
            <div class="orders-list" style="padding:20px;">
                <h3 style="margin-bottom:20px; color:var(--dark);"><i class="fab fa-whatsapp"></i> WhatsApp Admin</h3>
                <div class="form-group">
                    <label>N√∫mero de WhatsApp para cotizaciones:</label>
                    <div class="phone-wrap" style="max-width:400px;">
                        <select id="waCountryCode" style="width:100px;">
                            <option value="51">+51</option>
                            <option value="1">+1</option>
                            <option value="54">+54</option>
                            <option value="57">+57</option>
                            <option value="56">+56</option>
                        </select>
                        <input type="text" id="waAdminPhone" placeholder="993232534" style="flex:1;">
                    </div>
                    <small style="color:#666;">Ejemplo: +51 993232534</small>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Guardar</button>
                
                <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
                <h3 style="margin-bottom:20px; color:var(--dark);"><i class="fas fa-envelope"></i> Configuraci√≥n de Correo</h3>
                <div class="form-group">
                    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                        <input type="checkbox" id="emailEnabled" style="width:auto;">
                        <span>Activar env√≠o de correo al completar pedido</span>
                    </label>
                </div>
                <div class="form-group">
                    <label>Correos de destino (separados por coma):</label>
                    <input type="text" id="emailDestinatarios" placeholder="correo1@ejemplo.com, correo2@ejemplo.com">
                    <small style="color:#666;">Los pedidos completados se enviar√°n a estos correos</small>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Guardar Configuraci√≥n</button>
            </div>
        </div>
    </main>
    <div class="modal" id="orderModal">
        <div class="modal-content">
            <div class="modal-header"><h3>Pedido #<span id="orderModalId"></span></h3><button class="modal-close" onclick="closeModal()">√ó</button></div>
            <div class="modal-body" id="orderModalBody"></div>
        </div>
    </div>
    <div class="modal" id="photoModal" onclick="this.classList.remove('active')">
        <div style="max-width:90%;max-height:90vh;">
            <img id="photoView" style="max-width:100%;max-height:90vh;border-radius:8px;">
        </div>
    </div>
    <script>
        var currentStatus = "pending";
        var orders = [];
        
        function checkAuth() {
            var token = localStorage.getItem("cuix_admin_token");
            if (!token) { window.location.href = "/login.html"; return; }
            var user = JSON.parse(localStorage.getItem("cuix_admin_user") || "{}");
            if (user.name) { document.getElementById("userNameDisplay").textContent = user.name; document.getElementById("userInitial").textContent = user.name.charAt(0).toUpperCase(); }
        }
        
        function logout() { localStorage.removeItem("cuix_admin_token"); localStorage.removeItem("cuix_admin_user"); window.location.href = "/login.html"; }
        
        function showSection(section) {
            document.querySelectorAll(".sidebar-menu a").forEach(function(a){ a.classList.remove("active"); });
            event.target.closest("a").classList.add("active");
            document.getElementById("ordersSection").style.display = section === "orders" ? "block" : "none";
            document.getElementById("usersSection").style.display = section === "users" ? "block" : "none";
            document.getElementById("settingsSection").style.display = section === "settings" ? "block" : "none";
            if (section === "orders") loadOrders();
            if (section === "users") loadUsers();
            if (section === "settings") loadSettings();
        }
        
        function filterStatus(status) {
            currentStatus = status;
            document.querySelectorAll(".status-tab").forEach(function(t){ t.classList.remove("active"); });
            document.querySelector(".status-tab." + status).classList.add("active");
            loadOrders();
        }
        
        function loadOrders() {
            var token = localStorage.getItem("cuix_admin_token");
            fetch("/api/admin/orders", { headers: { "Authorization": "Bearer " + token } })
            .then(function(response){ if(response.status===401){logout();} return response.json(); })
            .then(function(data){
                console.log("Orders loaded:", data);
                orders = data.orders || [];
                // Sort by created_at descending (newest first)
                orders.sort(function(a,b){ return new Date(b.created_at) - new Date(a.created_at); });
                document.getElementById("countPending").textContent = orders.filter(function(o){return o.status==="pending"}).length;
                document.getElementById("countSent").textContent = orders.filter(function(o){return o.status==="sent"}).length;
                document.getElementById("countScheduled").textContent = orders.filter(function(o){return o.status==="scheduled"}).length;
                document.getElementById("countDelivered").textContent = orders.filter(function(o){return o.status==="delivered"}).length;
                var filtered = orders.filter(function(o){return o.status===currentStatus}).slice(0,50);
                var tbody = document.getElementById("ordersTableBody");
                if(filtered.length===0){tbody.innerHTML="<tr><td colspan=6 class=empty-state>No hay pedidos</td></tr>";return;}
                tbody.innerHTML = filtered.map(function(order){
                    return "<tr onclick='viewOrder("+order.id+")'><td>#"+order.id+"</td><td>"+(order.cliente||"Sin nombre")+"</td><td>"+(order.tipo||"Funko")+"</td><td>"+formatDate(order.created_at)+"</td><td>"+(order.price?"S/ "+order.price:"Por definir")+"</td><td>"+getActionButton(order)+"</td></tr>";
                }).join("");
            }).catch(function(e){ console.error("Error loading orders:", e); alert("Error: " + e); });
        }
        
        function getActionButton(order) {
            if(order.status==="pending") return "<button class=btn style='background:var(--warning);color:white;padding:5px 10px;font-size:12px' onclick=event.stopPropagation();viewOrder("+order.id+")>Editar</button>";
            if(order.status==="sent") return "<button class=btn style='background:var(--secondary);color:white;padding:5px 10px;font-size:12px' onclick=event.stopPropagation();viewOrder("+order.id+")>Agendar</button>";
            if(order.status==="scheduled") return "<button class=btn style='background:var(--success);color:white;padding:5px 10px;font-size:12px' onclick=event.stopPropagation();viewOrder("+order.id+")>Entregar</button>";
            return "";
        }
        
        function viewOrder(orderId) {
            var token = localStorage.getItem("cuix_admin_token");
            fetch("/api/admin/order/"+orderId, { headers: { "Authorization": "Bearer " + token } })
            .then(function(r){ return r.json(); })
            .then(function(order){
                document.getElementById("orderModalId").textContent = orderId;
                var modalBody = document.getElementById("orderModalBody");
                var orderData = order.order_data || {};
                var actions = "";
                if(order.status === "pending"){
                    var phoneVal = order.customer_phone || "";
                    // Extraer c√≥digo de pa√≠s y n√∫mero
                    var countryCode = "pe";
                    var phoneNumber = phoneVal;
                    if(phoneVal.indexOf("+51") > -1){ countryCode = "pe"; phoneNumber = phoneVal.replace("+51", ""); }
                    else if(phoneVal.indexOf("+1") > -1){ countryCode = "us"; phoneNumber = phoneVal.replace("+1", ""); }
                    else if(phoneVal.indexOf("+54") > -1){ countryCode = "ar"; phoneNumber = phoneVal.replace("+54", ""); }
                    else if(phoneVal.indexOf("+57") > -1){ countryCode = "co"; phoneNumber = phoneVal.replace("+57", ""); }
                    else if(phoneVal.indexOf("+56") > -1){ countryCode = "cl"; phoneNumber = phoneVal.replace("+56", ""); }
                    
                    phoneNumber = phoneNumber.trim();
                    actions = '<div class="form-group"><label>Cliente:</label><input type="text" id="customerName" value="'+(order.cliente||"")+'"></div>'+
                        '<div class="form-group"><label>Tel√©fono:</label><div class="phone-wrap"><img id="flagImg" src="https://flagcdn.com/w40/'+countryCode+'.png"><select id="countryCode" onchange="document.getElementById(\'flagImg\').src=\'https://flagcdn.com/w40/\'+this.value+\'.png\'"><option value="pe"'+(countryCode==="pe"?" selected":"")+'>+51</option><option value="us"'+(countryCode==="us"?" selected":"")+'>+1</option><option value="ar"'+(countryCode==="ar"?" selected":"")+'>+54</option><option value="co"'+(countryCode==="co"?" selected":"")+'>+57</option><option value="cl"'+(countryCode==="cl"?" selected":"")+'>+56</option></select><input type="text" id="customerPhone" value="'+phoneNumber+'" style="flex:1"></div></div>'+
                        '<div class="form-group"><label>Tipo:</label><select id="orderType"><option value="Funko Solo"'+(order.tipo==="Funko Solo"?" selected":"")+'>Funko Solo</option><option value="Funko Pareja"'+(order.tipo==="Funko Pareja"?" selected":"")+'>Funko Pareja</option><option value="Funko Mascota"'+(order.tipo==="Funko Mascota"?" selected":"")+'>Funko Mascota</option></select></div>'+
                        '<div class="form-group"><label>Precio:</label><input type="number" id="orderPrice" value="'+(order.price||"")+'"></div>'+
                        '<div class="form-buttons"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="savePendingOrder('+order.id+')">Guardar</button><button class="whatsapp-btn" onclick="sendWhatsAppPrice('+order.id+')">WhatsApp</button></div>';
                }else if(order.status === "sent"){
                    actions = '<div class="form-group"><label>Fecha:</label><input type="date" id="deliveryDate" value="'+(order.delivery_date||"")+'"></div>'+
                        '<div class="form-group"><label>Notas:</label><textarea id="deliveryNotes">'+(order.delivery_notes||"")+'</textarea></div>'+
                        '<div class="form-buttons"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveSchedule('+order.id+')">Confirmar</button></div>';
                }else if(order.status === "scheduled"){
                    actions = '<div class="form-group"><label>Notas:</label><textarea id="finalDeliveryNotes">'+(order.delivery_notes||"")+'</textarea></div>'+
                        '<div class="form-buttons"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-success" onclick="confirmDelivery('+order.id+')">Entregado</button></div>';
                }else{
                    actions = '<div class="detail-grid"><div class="detail-item"><div class="label">Cliente</div><div class="value">'+(order.cliente||"N/A")+'</div></div><div class="detail-item"><div class="label">Tel√©fono</div><div class="value">'+(order.customer_phone||"N/A")+'</div></div></div><button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>';
                }
                
                // Generar miniaturas de fotos con opcion de descargar
                var fotosHtml = '';
                if(orderData.fotos_referencia && orderData.fotos_referencia.length > 0){
                    fotosHtml = '<div class="photo-thumbnails">';
                    orderData.fotos_referencia.forEach(function(foto, index){
                        var imgData = foto.data || '';
                        if(imgData && imgData.indexOf('data:') === -1){
                            imgData = 'data:image/jpeg;base64,' + imgData;
                        }
                        fotosHtml += '<div style="position:relative;display:inline-block;">';
                        fotosHtml += '<img src="' + imgData + '" class="photo-thumb" onclick="viewPhoto(\'' + imgData + '\')" title="Foto ' + (index+1) + '">';
                        fotosHtml += '<a href="' + imgData + '" download="funko_foto_' + (index+1) + '.jpg" style="position:absolute;bottom:2px;right:2px;background:rgba(0,0,0,0.7);color:white;padding:2px 6px;border-radius:4px;font-size:10px;text-decoration:none;">Descargar</a>';
                        fotosHtml += '</div>';
                    });
                    fotosHtml += '</div>';
                }
                
                // Construir HTML organizado por secciones
                var modalContent = '';
                
                // Secci√≥n: Datos del Cliente
                modalContent += '<div class="detail-section">';
                modalContent += '<div class="detail-section-title">DATOS DEL CLIENTE</div>';
                modalContent += '<div class="detail-row"><span class="detail-label">Cliente</span><span class="detail-value">' + (order.cliente || 'N/A') + '</span></div>';
                modalContent += '<div class="detail-row"><span class="detail-label">Telefono</span><span class="detail-value">' + (order.customer_phone || 'N/A') + '</span></div>';
                modalContent += '<div class="detail-row"><span class="detail-label">Tipo de Funko</span><span class="detail-value">' + (order.tipo || 'Funko Personalizado') + '</span></div>';
                modalContent += '<div class="detail-row"><span class="detail-label">Precio</span><span class="detail-value">' + (order.price ? 'S/ ' + order.price : 'Por definir') + '</span></div>';
                modalContent += '</div>';
                
                // Secci√≥n: Detalles del Funko
                modalContent += '<div class="detail-section">';
                modalContent += '<div class="detail-section-title">DETALLES DEL FUNKO</div>';
                modalContent += '<div class="detail-row"><span class="detail-label">Cabeza</span><span class="detail-value">' + (orderData.cabeza || 'No especificado') + '</span></div>';
                modalContent += '<div class="detail-row"><span class="detail-label">Parte Superior</span><span class="detail-value">' + (orderData.parte_superior || 'No especificado') + '</span></div>';
                modalContent += '<div class="detail-row"><span class="detail-label">Parte Inferior</span><span class="detail-value">' + (orderData.parte_inferior || 'No especificado') + '</span></div>';
                modalContent += '<div class="detail-row"><span class="detail-label">Pies</span><span class="detail-value">' + (orderData.pies || 'No especificado') + '</span></div>';
                modalContent += '<div class="detail-row"><span class="detail-label">Detalles Adicionales</span><span class="detail-value">' + (orderData.detalles_adicionales || 'No especificado') + '</span></div>';
                modalContent += '</div>';
                
                // Secci√≥n: Fotos de Referencia
                var fotoCount = orderData.fotos_referencia ? orderData.fotos_referencia.length : 0;
                modalContent += '<div class="detail-section">';
                modalContent += '<div class="detail-section-title">FOTOS DE REFERENCIA (' + fotoCount + ')</div>';
                if(fotoCount > 0){
                    modalContent += fotosHtml;
                } else {
                    modalContent += '<span class="detail-label">No especificadas</span>';
                }
                modalContent += '</div>';
                
                modalBody.innerHTML = modalContent + actions;
                document.getElementById("orderModal").classList.add("active");
            }).catch(function(e){ console.error(e); alert("Error al cargar"); });
        }
        
        function savePendingOrder(orderId){
            var name = document.getElementById("customerName").value;
            var code = document.getElementById("countryCode").value;
            var phone = document.getElementById("customerPhone").value;
            var type = document.getElementById("orderType").value;
            var price = document.getElementById("orderPrice").value;
            if(!name){alert("Ingresa el nombre");return;}
            var fullPhone = "+"+(code==="pe"?"51":code==="us"?"1":code==="ar"?"54":code==="co"?"57":code==="cl"?"56":"51")+phone;
            
            // Convertir price a n√∫mero o null
            var priceValue = price ? parseFloat(price) : null;
            
            updateOrder(orderId,{customer_name:name,customer_phone:fullPhone,order_type:type,price:priceValue})
            .then(function(result){
                if(result.success){
                    alert("Cambios guardados");
                    closeModal();
                    loadOrders();
                } else {
                    alert("Error: " + (result.error || "No se pudieron guardar los cambios"));
                }
            })
            .catch(function(e){ 
                console.error(e);
                alert("Error al guardar: " + e); 
            });
        }
        
        function sendWhatsAppPrice(orderId){
            // Buscar el pedido en la lista global
            var order = orders.find(function(o){return o.id === orderId});
            if(!order){alert("Error: pedido no encontrado");return;}
            
            var name = document.getElementById("customerName").value;
            var code = document.getElementById("countryCode").value;
            var phone = document.getElementById("customerPhone").value;
            var type = document.getElementById("orderType").value;
            var price = document.getElementById("orderPrice").value;
            
            if(!name||!price){alert("Ingresa nombre y precio");return;}
            var fullPhone = "+"+(code==="pe"?"51":code==="us"?"1":code==="ar"?"54":code==="co"?"57":code==="cl"?"56":"51")+phone;
            
            // Convertir price a n√∫mero
            var priceValue = parseFloat(price);
            
            // Actualizar pedido
            updateOrder(orderId,{customer_name:name,customer_phone:fullPhone,order_type:type,price:priceValue,status:"sent"});
            
            // N√∫mero del admin (leer de configuraci√≥n)
            var adminPhone = localStorage.getItem("wa_admin_phone") || "51993232534";
            
            // Obtener detalles del pedido desde orderData
            var orderData = order.order_data || {};
            var cabeza = orderData.cabeza || "No especificado";
            var parteSuperior = orderData.parte_superior || "No especificado";
            var parteInferior = orderData.parte_inferior || "No especificado";
            var pies = orderData.pies || "No especificado";
            var fotos = orderData.fotos_referencia || [];
            var detallesAdicionales = orderData.detalles_adicionales || "No especificado";
            var fotoCount = fotos.length || 0;
            
            // Mensaje para el admin con emojis compatibles y bullets
            var mensaje = "*FUNKO NUEVO PEDIDO*\n";
            mensaje += "------------------------------\n\n";
            mensaje += "*DATOS DEL CLIENTE*\n";
            mensaje += "*   Cliente:* " + name + "\n";
            mensaje += "*   Telefono:* " + fullPhone + "\n";
            mensaje += "*   Tipo:* " + type + "\n";
            mensaje += "*   Precio:* S/ " + price + "\n\n";
            mensaje += "*DETALLES DEL FUNKO*\n";
            mensaje += "*   - Cabeza:* " + cabeza + "\n";
            mensaje += "*   - Parte Superior:* " + parteSuperior + "\n";
            mensaje += "*   - Parte Inferior:* " + parteInferior + "\n";
            mensaje += "*   - Pies:* " + pies + "\n";
            mensaje += "*   - Fotos:* " + fotoCount + " foto(s)\n";
            mensaje += "*   - Extras:* " + detallesAdicionales + "\n\n";
            mensaje += "------------------------------\n";
            mensaje += "Por favor revisar y responder.";
            
            // Codificar el mensaje para WhatsApp
            var waLinkPhone = adminPhone.replace(/\+/g, "");
            window.open("https://wa.me/" + waLinkPhone + "?text=" + encodeURIComponent(mensaje), "_blank");
            closeModal();
            loadOrders();
        }
        
        function saveSchedule(orderId){
            var date = document.getElementById("deliveryDate").value;
            var notes = document.getElementById("deliveryNotes").value;
            if(!date){alert("Selecciona fecha");return;}
            updateOrder(orderId,{delivery_date:date,delivery_notes:notes,status:"scheduled"});
            alert("Pedido agendado");
            closeModal();
            loadOrders();
        }
        
        function confirmDelivery(orderId){
            var notes = document.getElementById("finalDeliveryNotes").value;
            updateOrder(orderId,{delivery_notes:notes,status:"delivered"});
            alert("Pedido entregado");
            closeModal();
            loadOrders();
        }
        
        function updateOrder(orderId,data){
            console.log("Actualizando pedido:", orderId, data);
            var token = localStorage.getItem("cuix_admin_token");
            return fetch("/api/admin/order/"+orderId,{method:"PUT",headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},body:JSON.stringify(data)})
            .then(function(r){ 
                console.log("Respuesta status:", r.status);
                return r.json(); 
            })
            .then(function(data){
                console.log("Respuesta data:", data);
                return data;
            });
        }
        
        function closeModal(){ document.getElementById("orderModal").classList.remove("active"); }
        
        function viewPhoto(imgSrc){
            document.getElementById("photoView").src = imgSrc;
            document.getElementById("photoModal").classList.add("active");
        }
        
        function loadUsers(){
            var tbody = document.getElementById("usersTableBody");
            tbody.innerHTML="<tr><td colspan=6 class=empty-state>Cargando...</td></tr>";
            var token = localStorage.getItem("cuix_admin_token");
            fetch("/api/admin/users",{headers:{"Authorization":"Bearer "+token}})
            .then(function(r){if(r.status===401){logout();}return r.json();})
            .then(function(data){
                console.log("Users loaded:", data);
                tbody.innerHTML = data.users.map(function(u){
                    var deleteBtn = u.username === 'admin' ? '' : '<button class="btn" style="background:#e74c3c;color:white;padding:5px 10px;font-size:12px" onclick="event.stopPropagation();deleteUser('+u.id+',\''+u.username+'\')"><i class="fas fa-trash"></i></button>';
                    var editBtn = '<button class="btn" style="background:#3498db;color:white;padding:5px 10px;font-size:12px;margin-right:5px;" onclick="event.stopPropagation();editUser('+u.id+',\''+u.username+'\',\''+u.full_name+'\',\''+u.email+'\',\''+u.role+'\')"><i class="fas fa-edit"></i></button>';
                    return "<tr><td>"+u.id+"</td><td>"+u.username+"</td><td>"+u.full_name+"</td><td>"+u.email+"</td><td>"+u.role+"</td><td>"+editBtn+deleteBtn+"</td></tr>";
                }).join("");
            }).catch(function(){tbody.innerHTML="<tr><td colspan=6>Error</td></tr>";});
        }
        
        function loadSettings(){
            var waPhone = localStorage.getItem("wa_admin_phone") || "";
            var waCountryCode = localStorage.getItem("wa_country_code") || "51";
            
            // Extraer c√≥digo de pa√≠s y n√∫mero
            if(waPhone){
                if(waPhone.indexOf("+51") === 0){ waCountryCode = "51"; waPhone = waPhone.replace("+51", ""); }
                else if(waPhone.indexOf("+1") === 0){ waCountryCode = "1"; waPhone = waPhone.replace("+1", ""); }
                else if(waPhone.indexOf("+54") === 0){ waCountryCode = "54"; waPhone = waPhone.replace("+54", ""); }
                else if(waPhone.indexOf("+57") === 0){ waCountryCode = "57"; waPhone = waPhone.replace("+57", ""); }
                else if(waPhone.indexOf("+56") === 0){ waCountryCode = "56"; waPhone = waPhone.replace("+56", ""); }
            }
            
            document.getElementById("waCountryCode").value = waCountryCode;
            document.getElementById("waAdminPhone").value = waPhone;
            
            // Cargar configuraci√≥n de correo desde el servidor
            var token = localStorage.getItem("cuix_admin_token");
            fetch("/api/admin/settings", {
                headers: {"Authorization": "Bearer " + token}
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                document.getElementById("emailEnabled").checked = data.email_enabled !== false;
                document.getElementById("emailDestinatarios").value = data.email_destinatarios || "cuicuix.studio@gmail.com";
            })
            .catch(function(e) {
                console.error("Error loading settings:", e);
                document.getElementById("emailEnabled").checked = true;
                document.getElementById("emailDestinatarios").value = "cuicuix.studio@gmail.com";
            });
        }
        
        function saveSettings(){
            var countryCode = document.getElementById("waCountryCode").value;
            var waPhone = document.getElementById("waAdminPhone").value.trim();
            if(!waPhone){alert("Ingresa el n√∫mero de WhatsApp");return;}
            
            var fullPhone = "+" + countryCode + waPhone;
            localStorage.setItem("wa_admin_phone", fullPhone);
            localStorage.setItem("wa_country_code", countryCode);
            
            // Guardar configuraci√≥n de correo en el servidor
            var emailEnabled = document.getElementById("emailEnabled").checked;
            var emailDestinatarios = document.getElementById("emailDestinatarios").value.trim();
            
            var token = localStorage.getItem("cuix_admin_token");
            fetch("/api/admin/settings", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({
                    email_enabled: emailEnabled,
                    email_destinatarios: emailDestinatarios
                })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if(data.success) {
                    alert("Configuraci√≥n guardada");
                } else {
                    alert("Error: " + (data.error || "Unknown error"));
                }
            })
            .catch(function(e) {
                console.error("Error saving settings:", e);
                alert("Error al guardar configuraci√≥n");
            });
        }
        
        function showCreateUserModal(){
            document.getElementById("orderModal").classList.add("active");
            document.getElementById("orderModalBody").innerHTML = '<div class="form-group"><label>Usuario:</label><input type="text" id="newUsername"></div>'+
                '<div class="form-group"><label>Contrase√±a:</label><input type="password" id="newPassword"></div>'+
                '<div class="form-group"><label>Nombre:</label><input type="text" id="newFullName"></div>'+
                '<div class="form-group"><label>Email:</label><input type="email" id="newEmail"></div>'+
                '<div class="form-group"><label>Rol:</label><select id="newRole"><option value="editor">Editor</option><option value="admin">Admin</option></select></div>'+
                '<div class="form-buttons"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="createUser()">Crear</button></div>';
        }
        
        function createUser(){
            var username = document.getElementById("newUsername").value;
            var password = document.getElementById("newPassword").value;
            var full_name = document.getElementById("newFullName").value;
            var email = document.getElementById("newEmail").value;
            var role = document.getElementById("newRole").value;
            
            if(!username || !password){alert("Usuario y contrase√±a requeridos");return;}
            
            var token = localStorage.getItem("cuix_admin_token");
            fetch("/api/admin/users",{
                method:"POST",
                headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},
                body:JSON.stringify({username,password,full_name,email,role})
            }).then(function(r){return r.json();})
            .then(function(data){
                if(data.success){closeModal();loadUsers();alert("Usuario creado");}
                else{alert(data.error);}
            }).catch(function(){alert("Error");});
        }
        
        function deleteUser(id,username){
            if(!confirm("¬øEliminar usuario "+username+"?"))return;
            var token = localStorage.getItem("cuix_admin_token");
            fetch("/api/admin/user/"+id,{method:"DELETE",headers:{"Authorization":"Bearer "+token}})
            .then(function(r){return r.json();})
            .then(function(data){
                if(data.success){loadUsers();}
                else{alert(data.error);}
            }).catch(function(){alert("Error");});
        }

        function editUser(id, username, full_name, email, role){
            document.getElementById("orderModal").classList.add("active");
            document.getElementById("orderModalBody").innerHTML = '<div class="form-group"><label>Usuario:</label><input type="text" id="editUsername" value="'+username+'" disabled style="background:#eee;"></div>'+
                '<div class="form-group"><label>Nueva Contrase√±a:</label><input type="password" id="editPassword" placeholder="Dejar vac√≠o para mantener actual"></div>'+
                '<div class="form-group"><label>Nombre:</label><input type="text" id="editFullName" value="'+full_name+'"></div>'+
                '<div class="form-group"><label>Email:</label><input type="email" id="editEmail" value="'+email+'"></div>'+
                '<div class="form-group"><label>Rol:</label><select id="editRole"><option value="admin" '+(role==='admin'?'selected':'')+'>Admin</option><option value="editor" '+(role==='editor'?'selected':'')+'>Editor</option><option value="viewer" '+(role==='viewer'?'selected':'')+'>Viewer</option></select></div>'+
                '<div class="form-buttons"><button class="btn btn-secondary" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="updateUser('+id+')">Guardar</button></div>';
        }

        function updateUser(id){
            var full_name = document.getElementById("editFullName").value;
            var email = document.getElementById("editEmail").value;
            var role = document.getElementById("editRole").value;
            var password = document.getElementById("editPassword").value;

            if(!full_name || !email){alert("Nombre y email requeridos");return;}

            var token = localStorage.getItem("cuix_admin_token");
            var data = {full_name:full_name,email:email,role:role};
            if(password){data.password = password;}

            fetch("/api/admin/user/"+id,{
                method:"PUT",
                headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},
                body:JSON.stringify(data)
            }).then(function(r){return r.json();})
            .then(function(data){
                if(data.success){closeModal();loadUsers();alert("Usuario actualizado");}
                else{alert(data.error);}
            }).catch(function(){alert("Error");});
        }
        
        function formatDate(d){ if(!d)return"N/A"; return new Date(d).toLocaleDateString("es-PE",{day:"2-digit",month:"2-digit",year:"numeric"}); }
        
        document.getElementById("orderModal").addEventListener("click",function(e){ if(e.target===this)closeModal(); });
        checkAuth();
        loadOrders();
    </script>
</body>
</html>